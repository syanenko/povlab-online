<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-4BTQWYDYSB"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-4BTQWYDYSB');
    </script>

    <title>POV-Render</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="expires" content="timestamp">
    <link type="text/css" rel="stylesheet" href="/index.css">
    <script src="https://code.jquery.com/jquery-1.11.3.min.js"></script>
  </head>

  <body>
  <!-- Header --> 
  <div id='header'></div>
  <!-- Insert header -->
  <script>
    fetch("/header.html")
      .then(response => {
        return response.text()
      }).then(data => {
        document.getElementById('header').innerHTML = data;
      });

    function showAbout()
    {
      document.getElementById("about").showModal();
    }
  </script>

  <div id='name'>Renderer</div>
  <img id='result' alt="Rendering result">

  <form id="form_upload_code" encType="multipart/form-data" style="text-align:left">
    <textarea id="editor">
  /*
      #include "colors.inc"
      #include "glass.inc"
      #include "golds.inc"
      #include "metals.inc"
      #include "stones.inc"
      #include "woods.inc"
  */
      camera {
        sky <0,0,1>
        direction <-1,0,0>
        right <-4/3,0,0>
        location <30,10,1.5>
        look_at <0,0,0.5>
        angle 15
      }

      global_settings { ambient_light color rgb< 1.0, 1.0, 1.0> }

      light_source {
        <10,-10,20>
        color rgb< 1.0, 1.0, 1.0> * 2
      }

      background { color <0, 0, 0> }
      plane {
        <0,0,1>, 0
        texture { pigment{ color rgb<0.4, 0.4, 0.4> }
                finish { phong 1 reflection 0.00}
              }
      }

      sphere { <0,0,1.5>, 1
          texture { pigment{ color rgb< 0.5, 0.2, 0.0> }
                    finish { phong 1 reflection 0.00}
                  }
      }
    </textarea>

    <input type="submit" value="Upload" id="upload_code" style="position:absolute; left:260px; bottom:10px; width:120px; z-index:2;" /> 
  </form>

  <script>
    var form = document.getElementById('form_upload_code');

    form.addEventListener('submit', function(e) {
      e.preventDefault();

      var formData = new FormData();
      const editor  = document.getElementById("editor")
      const blob = new Blob([editor.value], { type: "text/plain" });
      formData.append("scene", blob, 'scene.pov');

      // Display model name
      /*/
      var scene_name = document.getElementById('scene_name'); 
      scene_name.innerHTML ='[' + scene.name + ']';
      */
      var xhr = new XMLHttpRequest();

      // Check before deploy !
      // xhr.open('POST', 'http://localhost:8083/render/render_pov.php');
      xhr.open('POST', 'https://povlab.online/render/render_pov.php');

      xhr.responseType = 'json';
      xhr.onload = function() {
        if (xhr.status === 200) {
          console.log(xhr.response);           
          document.getElementById("result").src = "https://povlab.online/render/" + xhr.response;
        } else {
          console.error(xhr.response);
        }
      }
      xhr.send(formData);
    });
  </script>

<!--
  <script>
    const send  = document.getElementById("upload_code")
    send.addEventListener("click", async () => {
      const formData = new FormData();
      const editor  = document.getElementById("editor")
      console.log(editor.textContent); // DEBUG !
      const blob = new Blob([editor.textContent], { type: "text/plain" });
      formData.append("scene", blob, 'scene.pov');

      // Check befor deploy ! 
      //const response = await fetch("http://localhost:8083/render/render_pov.php", {
      const response = await fetch("https://povlab.online/render/render_pov.php", {
        method: "POST",
        body: formData,
      });
     
      await response.json().then((result) => {
        console.log(result);
        document.getElementById("result").src = "https://povlab.online/render/" + result;
      });
    });
  </script>
-->
  <div id="scene_name" style='z-index:2'>[Demo scene]</div>
  <!-- Render -->
  <div id="container" style='height: 100vh; width: 100%; position: absolute; z-index:-1'></div>

  <!-- Video
  <video id="video" style='transform: translate(-50%, -50%);  position: absolute;  top: 50%; left: 50%; display:none; object-fit: fill;' playsinline></video>
  -->
  <video id="video" style='height:100vh; width:100%; position:absolute; z-index:0; visibility:hidden' playsinline></video>
  <input id="video_button" type="image" src="./data/icons/outline_videocam_white_48dp.png" style='z-index:2'/>
  <script>
    vb = document.getElementById("video_button");
    vb.onmouseenter = function () {
      vb.style.opacity = '1.0';
    };

    vb.onmouseleave = function () {
      vb.style.opacity = '0.5';
    };
  </script>

  <input id="upload_button" type="image" src="./data/icons/outline_file_upload_white_48dp.png", style='z-index:2'/>
  <script>
    ub = document.getElementById("upload_button");
    ub.onmouseenter = function () {
      ub.style.opacity = '1.0';
    };

    ub.onmouseleave = function () {
      ub.style.opacity = '0.5';
    };

    ub.onclick = function() { let form = document.getElementById("form_upload");
                              form.style.visibility == "visible" ? form.style.visibility = 'hidden': form.style.visibility = "visible"; }
  </script>
  <!-- Import Three
  <script type="importmap">
    {
      "imports": {
        "three": "./three/three.module.js",
        "three/addons/": "./three/jsm/"
      }
    }
  </script>
  -->
  <script type="module" src="index.js"></script>
  
  <!-- Upload scene -->
  <div>
    <form id="form_upload" encType="multipart/form-data" style="text-align:left">
        <h3>Upload scene</h3>
      Geometry&nbsp;<input type="file" name="scene" accept=".pov,.obj"/><br/>
      <input type="submit"  value="Upload" style="margin-left:80px"/>&nbsp;&nbsp;&nbsp;&nbsp;
      <input type="button"  value="Cancel" onclick="parentElement.style.visibility = 'hidden'"/>
    </form>
  </div>

  <script>
    var form = document.getElementById('form_upload');

    // Add a submit event listener to the form
    form.addEventListener('submit', function(e) {
      // Prevent the default form submission behavior
      e.preventDefault();

      // Create a new FormData object
      var formData = new FormData();

      // Get the selected file
      var scene = form.querySelector('[name="scene"]').files[0];

      // Add the file to the FormData object
      formData.append('scene', scene);

      // Display model name
      var scene_name = document.getElementById('scene_name'); 
      scene_name.innerHTML ='[' + scene.name + ']';
  
      // Create an XMLHttpRequest object
      var xhr = new XMLHttpRequest();

      // Check before deploy !
      // xhr.open('POST', 'http://localhost:8083/render/render_pov.php');
      xhr.open('POST', 'https://povlab.online/render/render_pov.php');

      // Set the request as asynchronous
      xhr.responseType = 'json';

      // Set the request onload event listener
      xhr.onload = function() {
        if (xhr.status === 200) {
          console.log(xhr.response);           
          document.getElementById("result").src = "https://povlab.online/render/" + xhr.response;
        } else {
          // There was an error uploading the image
          console.error(xhr.response);
        }
      }
      // Send the request
      xhr.send(formData);
      form.reset();
      form.style.visibility = 'hidden';
    });
  </script>

  </body>
</html>
