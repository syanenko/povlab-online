<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-4BTQWYDYSB"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-4BTQWYDYSB');
    </script>

    <title>POV-Render</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="expires" content="timestamp">
    <link type="text/css" rel="stylesheet" href="index.css">
    <script src="https://code.jquery.com/jquery-1.11.3.min.js"></script>
  </head>

  <body>
    <!-- Header --> 
    <div id='header'></div>
    <div id='name'>Renderer</div>

    <textarea id="editor">
//EXAMPLE OF SPHERE

//Files with predefined colors and textures
#include "colors.inc"
#include "glass.inc"
#include "golds.inc"
#include "metals.inc"
#include "stones.inc"
#include "woods.inc"

//Place the camera
camera {
  sky <0,0,1>           //Don't change this
  direction <-1,0,0>    //Don't change this  
  right <-4/3,0,0>      //Don't change this
  location <30,10,1.5> //Camera location
  look_at <0,0,0>     //Where camera is pointing
  angle 15      //Angle of the view--increase to see more, decrease to see less
}

//Ambient light to "brighten up" darker pictures
global_settings { ambient_light White }

//Place a light--you can have more than one!
light_source {
  <10,-10,20>   //Change this if you want to put the light at a different point
  color White*2         //Multiplying by 2 doubles the brightness
}

//Set a background color
background { color White }

//Create a "floor"
plane {
  <0,0,1>, 0            //This represents the plane 0x+0y+z=0
  texture { T_Silver_3A }       //The texture comes from the file "metals.inc"
}

//Sphere with specified center point and radius
//The texture comes from the file "stones.inc"
sphere { <0,0,1.5>, 1 texture {T_Stone1} }
</textarea>

<button id="send" style="position:absolute; left:200px; bottom:10px; z-index:2;">Upload</button>
<script>
const send = document.querySelector("#send");
send.addEventListener("click", async () => {
  const formData = new FormData();
  const editor = document.querySelector("#editor");  
  const blob = new Blob([editor.innerHTML], { type: "text/xml" });
  formData.append("model", blob, 'scene.pov');

  const response = await fetch("https://povlab.online/render/render_pov.php", {
    method: "POST",
    body: formData,
  });
  console.log(await response.json());
});
</script>

    <!-- About -->
    <dialog id="about">
      <div style="font-size: 24px; color:#ff9127">POV Renderer</div>
      <p>Remote rendering of POV scenes.</p>
      <p>Code: <a href="https://github.com/syanenko/zxr">GitHub</a><br>Contact: <a href="https://www.linkedin.com/in/sergey-yanenko-57b21a96/">LinkedIn</a></p>
      <form method="dialog" style="text-align:center">
        <button>&nbsp;&nbsp;&nbsp;OK&nbsp;&nbsp;&nbsp;</button>
      </form>
    </dialog>

    <div id="model_name" style='z-index:2'>[Demo scene]</div>
    <!-- Render -->
    <div id="container" style='height: 100vh; width: 100%; position: absolute; z-index:1'></div>

    <!-- Insert header -->
    <script>
      fetch("/header.html")
        .then(response => {
          return response.text()
        }).then(data => {
          document.getElementById('header').innerHTML = data;
        });
    </script>

    <!-- Video
    <video id="video" style='transform: translate(-50%, -50%);  position: absolute;  top: 50%; left: 50%; display:none; object-fit: fill;' playsinline></video>
    -->
    <video id="video" style='height:100vh; width:100%; position:absolute; z-index:0; visibility:hidden' playsinline></video>
    <input id="video_button" type="image" src="./data/icons/outline_videocam_white_48dp.png" style='z-index:2'/>
    <script>
      vb = document.getElementById("video_button");
      vb.onmouseenter = function () {
        vb.style.opacity = '1.0';
      };

      vb.onmouseleave = function () {
        vb.style.opacity = '0.5';
      };
    </script>

    <input id="upload_button" type="image" src="./data/icons/outline_file_upload_white_48dp.png", style='z-index:2'/>
    <script>
      ub = document.getElementById("upload_button");
      ub.onmouseenter = function () {
        ub.style.opacity = '1.0';
      };

      ub.onmouseleave = function () {
        ub.style.opacity = '0.5';
      };

      ub.onclick = function() { let form = document.getElementById("form_upload");
                                form.style.visibility == "visible" ? form.style.visibility = 'hidden': form.style.visibility = "visible"; }
    </script>

    <!-- Imports
    <script type="importmap">
      {
        "imports": {
          "three": "./three/three.module.js",
          "three/addons/": "./three/jsm/"
        }
      }
    </script>
    -->
    <script type="module" src="index.js"></script>
    
    <!-- Upload scene -->
    <div id="form_upload">
      <form encType="multipart/form-data" style="text-align:left">
          <h3>Upload scene</h3>
        Geometry&nbsp;<input type="file" name="model" accept=".obj"/><br/>
        Texture&nbsp;&nbsp;<input type="file" name="texture" accept=".bmp,.png,.jpeg,.jpg"/><br/>
        Normals&nbsp;&nbsp;<input type="file" name="normals" accept=".bmp,.png,.jpeg,.jpg"/><br/><br/>
        <input type="submit"  value="Upload" style="margin-left:80px"/>&nbsp;&nbsp;&nbsp;&nbsp;
        <input type="button"  value="Cancel" onclick="parentElement.parentElement.style.visibility = 'hidden'"/>
      </form>
    </duv>

    <script>
      var form = document.getElementById('form_upload');

      // Add a submit event listener to the form
      form.addEventListener('submit', function(e) {
        // Prevent the default form submission behavior
        e.preventDefault();

        // Create a new FormData object
        var formData = new FormData();

        // Get the selected file
        var model   = form.querySelector('[name="model"]'  ).files[0];
        var texture = form.querySelector('[name="texture"]').files[0];
        var normals = form.querySelector('[name="normals"]').files[0];

        // Add the file to the FormData object
        formData.append('model',   model);
        formData.append('texture', texture);
        formData.append('normals', normals);

        // Display model name
        var model_name = document.getElementById('model_name'); 
        model_name.innerHTML ='[' + model.name + ']';
   
        // Create an XMLHttpRequest object
        var xhr = new XMLHttpRequest();

        // Set the request url - check it before publishing
        // xhr.open('POST', 'http://localhost:3000/render/render_pov.php');
        xhr.open('POST', 'https://povlab.online/render/render_pov.php');

        // Set the request as asynchronous
        xhr.responseType = 'json';

        // Set the request onload event listener
        xhr.onload = function() {
          if (xhr.status === 200) {
            // Render here 
//            window.loadModel({model:xhr.response});
           
          } else {
            // There was an error uploading the image
            console.error(xhr.response);
          }
        }
        // Send the request
        xhr.send(formData);
        form.style.visibility = 'hidden';
      });
    </script>

  </body>
</html>
